<!DOCTYPE html>
<html lang="no">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Eksperiment: Tastatur, Touch og Stemme</title>
    <!--
        Prosjekt: Interaksjonseksperiment ‚Äì Touchscreen, Tastatur/Mus og Tale
        Forfatter: Ramin (OsloMet IT-student)
        Notat: Alt lokalt. Bruker Web Speech API n√•r tilgjengelig. Laster ned CSV lokalt ved slutt.
    -->
    <style>
        /* Enkel, mobil-f√∏rst responsiv styling med tilgjengelig kontrast og store touch-m√•l */
        :root {
            --max-width: 900px;
            --accent: #2468f0;
            --accent-2: #24a85a;
            --bg: #fbfbfd;
            --card: #fff;
            --muted: #666;
        }

        html,
        body {
            height: 100%;
        }

        body {
            font-family: "Segoe UI", Roboto, Arial, sans-serif;
            margin: 0;
            padding: 16px;
            background: var(--bg);
            color: #111;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: var(--max-width);
        }

        header {
            text-align: center;
            margin: 8px 0 18px
        }

        h1 {
            font-size: 1.25rem;
            margin: 0
        }

        main {
            background: var(--card);
            border-radius: 12px;
            padding: 14px;
            box-shadow: 0 4px 18px rgba(0, 0, 0, 0.06)
        }

        .phase-title {
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center
        }

        /* Bilder-rutenett */
        #imageContainer {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 10px 0
        }

        .imageBox {
            width: 30%;
            min-width: 90px;
            text-align: center
        }

        .imageBox img {
            width: 100%;
            height: 90px;
            object-fit: contain;
            border-radius: 8px;
            background: #fff;
            padding: 6px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06)
        }

        .caption {
            font-size: 0.9rem;
            color: var(--muted);
            margin-top: 6px
        }

        /* Inndatafelt */
        label[for="inputField"] {
            display: block;
            font-size: 0.95rem;
            margin: 10px 0 6px
        }

        textarea {
            width: 100%;
            min-height: 88px;
            padding: 10px;
            font-size: 1rem;
            border-radius: 8px;
            border: 1px solid #dcdcdc;
            resize: vertical
        }

        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 10px
        }

        button {
            padding: 10px 14px;
            border-radius: 10px;
            border: none;
            background: var(--accent);
            color: #fff;
            font-size: 0.98rem;
            cursor: pointer
        }

        .secondary {
            background: #666
        }

        .voice {
            background: var(--accent-2)
        }

        .status {
            margin-top: 10px;
            text-align: center;
            color: var(--muted)
        }

        /* Sp√∏rreskjema */
        .questionnaire {
            margin-top: 14px;
            border-top: 1px dashed #eee;
            padding-top: 12px
        }

        .likert {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap
        }

        .likert label {
            font-size: 0.9rem;
            margin-right: 8px
        }

        .likert .scale {
            display: flex;
            gap: 6px
        }

        .likert input[type="radio"] {
            width: 20px;
            height: 20px
        }

        footer {
            margin-top: 12px;
            text-align: center;
            font-size: 0.82rem;
            color: var(--muted)
        }

        @media(min-width:720px) {
            .imageBox {
                width: 28%
            }

            h1 {
                font-size: 1.6rem
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Eksperiment: Tastatur, Touch og Stemme</h1>
            <p class="muted">To oppgaver: Komposisjon (bildene) og Transkripsjon (skriv n√∏yaktig setning).</p>
        </header>

        <main id="main" role="main">
            <!-- üü¢ STARTSIDE f√∏r eksperimentet -->
            <section id="introScreen">
                <h2>Velkommen til eksperimentet</h2>
                <p>Dette eksperimentet sammenligner tre m√•ter √• skrive p√•:
                    <strong>Tastatur/mus</strong>, <strong>Touch</strong> og <strong>Tale</strong>.
                </p>

                <p>Du skal gj√∏re <strong>to typer oppgaver:</strong></p>
                <ol>
                    <li><strong>Komposisjon:</strong> Du f√•r se tre bilder. Skriv eller si en kort og meningsfull
                        setning som beskriver dem. <br>
                        <em>Eksempel:</em> Hvis du ser <strong>Gutt</strong>, <strong>Katt</strong> og
                        <strong>B√•t</strong>, kan du skrive:
                        <span style="color:#2468f0">¬´Gutten tar med katten sin p√• b√•ten.¬ª</span>
                    </li>
                    <li style="margin-top:8px"><strong>Transkripsjon:</strong> Du f√•r se en setning. Skriv den n√∏yaktig
                        slik den st√•r.</li>
                </ol>

                <p>Tiden m√•les automatisk, s√• pr√∏v √• jobbe naturlig, men uten √• stresse. Etter alle oppgavene f√•r du et
                    kort sp√∏rreskjema, og resultatene lastes ned automatisk som en CSV-fil.</p>

                <div style="text-align:center;margin-top:20px">
                    <button id="startButton"
                        style="padding:12px 24px;font-size:1rem;border-radius:8px;background:#2468f0;color:white;border:none;cursor:pointer;">
                        üöÄ Start eksperiment
                    </button>
                </div>
            </section>

            <!-- üîµ EKSPERIMENTDEL (skjules til startknapp trykkes) -->
            <section id="experimentSection" hidden>
                <div class="phase-title" id="phaseTitle" aria-live="polite"></div>
                <div id="imageContainer" aria-hidden="false"></div>
                <p id="promptText" style="text-align:center;font-weight:600"></p>

                <label for="inputField">Svar (skriv eller bruk mikrofon)</label>
                <textarea id="inputField" placeholder="Skriv eller snakk her..." aria-label="Svarfelt"></textarea>

                <div class="controls">
                    <button id="voiceButton" class="voice" aria-pressed="false" aria-label="Start stemmeopptak">üé§
                        Tale</button>
                    <button id="submitButton">‚úÖ Send inn</button>
                    <button id="skipButton" class="secondary">Hopp over</button>
                </div>

                <div id="status" class="status" aria-live="assertive"></div>
                <div id="progress" class="status" aria-live="polite"></div>

                <!-- Sp√∏rreskjema vises f√∏rst etter alle oppgaver -->
                <section id="questionnaire" class="questionnaire" hidden>
                    <h3>Kort evaluering</h3>
                    <p>Vennligst vurder f√∏lgende p√• en skala fra 1 (lav) til 5 (h√∏y):</p>
                    <div>
                        <div class="likert">
                            <label for="q1">Hvor forn√∏yd er du med denne opplevelsen?</label>
                            <div class="scale" id="q1">
                                <label><input type="radio" name="q1" value="1">1</label>
                                <label><input type="radio" name="q1" value="2">2</label>
                                <label><input type="radio" name="q1" value="3" checked>3</label>
                                <label><input type="radio" name="q1" value="4">4</label>
                                <label><input type="radio" name="q1" value="5">5</label>
                            </div>
                        </div>
                        <div class="likert" style="margin-top:8px">
                            <label for="q2">Hvor mye anstrengelse brukte du?</label>
                            <div class="scale" id="q2">
                                <label><input type="radio" name="q2" value="1">1</label>
                                <label><input type="radio" name="q2" value="2">2</label>
                                <label><input type="radio" name="q2" value="3" checked>3</label>
                                <label><input type="radio" name="q2" value="4">4</label>
                                <label><input type="radio" name="q2" value="5">5</label>
                            </div>
                        </div>
                        <div style="margin-top:8px">
                            <label for="comments">Kommentarer (valgfritt)</label>
                            <input id="comments" type="text"
                                style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd"
                                aria-label="Kommentarer">
                        </div>
                    </div>
                    <div style="text-align:center;margin-top:10px">
                        <button id="finishButton">Fullf√∏r og last ned resultater</button>
                    </div>
                </section>
            </section>
        </main>


        <footer>
            <small>Alle bilder ligger lokalt i /images/. For tales√∏k anbefales Chrome eller Edge.</small>
        </footer>
    </div>

    <script>
        (async function () {
            // ------- Konfigurasjon og oppgaver -------
            const compositionTasks = [
                [{ src: 'images/boy.png', label: 'Gutt' }, { src: 'images/boat.png', label: 'B√•t' }, { src: 'images/cat.png', label: 'Katt' }],
                [{ src: 'images/apple.png', label: 'Eple' }, { src: 'images/doctor.png', label: 'Lege' }, { src: 'images/house.png', label: 'Hus' }],
                [{ src: 'images/woman.png', label: 'Kvinne' }, { src: 'images/plane.png', label: 'Fly' }, { src: 'images/baby.png', label: 'Baby' }],
                [{ src: 'images/man.png', label: 'Mann' }, { src: 'images/dog.png', label: 'Hund' }, { src: 'images/car.png', label: 'Bil' }],
                [{ src: 'images/girl.png', label: 'Jente' }, { src: 'images/bicycle.png', label: 'Sykkel' }, { src: 'images/tree.png', label: 'Tre' }],
                [{ src: 'images/teacher.png', label: 'L√¶rer' }, { src: 'images/book.png', label: 'Bok' }, { src: 'images/classroom.png', label: 'Klasserom' }],
                [{ src: 'images/chef.png', label: 'Kokk' }, { src: 'images/pizza.png', label: 'Pizza' }, { src: 'images/kitchen.png', label: 'Kj√∏kken' }],
                [{ src: 'images/firefighter.png', label: 'Brannmann' }, { src: 'images/firetruck.png', label: 'Brannbil' }, { src: 'images/fire.png', label: 'Ild' }],
                [{ src: 'images/policeman.png', label: 'Politimann' }, { src: 'images/car.png', label: 'Bil' }, { src: 'images/road.png', label: 'Vei' }],
                [{ src: 'images/student.png', label: 'Student' }, { src: 'images/laptop.png', label: 'Laptop' }, { src: 'images/coffee.png', label: 'Kaffe' }]
            ];


            const transcriptionTasks = [
                'Gutten tar med katten sin p√• b√•ten.',
                'Legen spiser et eple f√∏r han drar hjem.',
                'Kvinnen flyr med babyen sin p√• flyet.',
                'Mannen kj√∏rer bilen sin mens hunden ser ut av vinduet.',
                'Jenta sykler gjennom skogen ved et stort tre.',
                'L√¶reren holder en bok foran klassen i klasserommet.',
                'Kokken lager pizza p√• kj√∏kkenet sitt.',
                'Brannmannen slukker ild med en brannbil.',
                'Politimannen patruljerer veien i bilen sin.',
                'Studenten jobber p√• laptopen sin med en kopp kaffe ved siden av.'
            ];


            // Resultater samles lokalt
            const results = [];

            let phase = 'composition';
            let taskIndex = 0;
            let startTime = null;
            let recognition = null;

            // Enkel DOM-hjelper
            const el = id => document.getElementById(id);
            const phaseTitle = el('phaseTitle');
            const imageContainer = el('imageContainer');
            const promptText = el('promptText');
            const inputField = el('inputField');
            const status = el('status');
            const progress = el('progress');
            const voiceButton = el('voiceButton');
            const submitButton = el('submitButton');
            const skipButton = el('skipButton');
            const questionnaire = el('questionnaire');
            const finishButton = el('finishButton');

            // Deltakerinfo via modal (erstatter prompt). Returnerer Promise som resolves n√•r info er klar.
            function getParticipantInfo() {
                const storedPid = localStorage.getItem('participantID');
                const storedIface = localStorage.getItem('interfaceType');
                const pid = storedPid && storedPid.trim() ? storedPid : 'ukjent';
                const iface = storedIface && storedIface.trim() ? storedIface : 'ukjent';
                // s√∏rg for at verdiene er lagret for senere
                if (!storedPid) localStorage.setItem('participantID', pid);
                if (!storedIface) localStorage.setItem('interfaceType', iface);
                return { participant: pid, interfaceType: iface };
            }

            // F√• deltakerinfo f√∏r vi fortsetter
            const meta = await getParticipantInfo();

            // ------- Render n√•v√¶rende oppgave -------
            function renderTask() {
                status.textContent = '';
                inputField.value = '';
                inputField.style.display = ''; // synlig igjen ved nye oppgaver
                startTime = null;

                if (phase === 'composition') {
                    phaseTitle.textContent = 'DEL 1: Lag en kort setning som passer til disse bildene:';
                    imageContainer.innerHTML = '';
                    promptText.textContent = '';
                    const cards = compositionTasks[taskIndex];
                    cards.forEach(item => {
                        const box = document.createElement('div');
                        box.className = 'imageBox';
                        const img = document.createElement('img');
                        img.src = item.src;
                        img.alt = item.label;
                        const cap = document.createElement('div');
                        cap.className = 'caption';
                        cap.textContent = item.label;
                        box.appendChild(img);
                        box.appendChild(cap);
                        imageContainer.appendChild(box);
                    });
                    progress.textContent = `Oppgave ${taskIndex + 1} av ${compositionTasks.length}`;
                } else {
                    phaseTitle.textContent = 'DEL 2: Skriv eller si setningen n√∏yaktig slik den st√•r her:';
                    imageContainer.innerHTML = '';
                    promptText.textContent = transcriptionTasks[taskIndex];
                    progress.textContent = `Setning ${taskIndex + 1} av ${transcriptionTasks.length}`;
                }
            }

            // ------- Tidtaking og inndata -------
            inputField.addEventListener('focus', () => { if (!startTime) startTime = performance.now(); });
            inputField.addEventListener('input', () => { if (!startTime) startTime = performance.now(); });

            // Knapphandlinger
            submitButton.addEventListener('click', () => handleSubmit(false));
            skipButton.addEventListener('click', () => handleSubmit(true));

            // Ctrl/Cmd+Enter for innsending (Enter alene gir linjeskift)
            inputField.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); handleSubmit(false); }
            });

            function handleSubmit(skipped) {
                if (!startTime) { alert('Klikk i tekstfeltet eller bruk mikrofon f√∏r du sender inn.'); return; }
                const endTime = performance.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);
                const text = skipped ? '' : inputField.value.trim();

                // Beregn n√∏yaktighet for transkripsjon
                let accuracy = '';
                if (phase === 'transcription') {
                    const target = transcriptionTasks[taskIndex].trim();
                    accuracy = computeAccuracy(target, text).toFixed(2);
                }

                // Lagre rad
                const row = {
                    participant: meta.participant,
                    interface: meta.interfaceType,
                    taskType: phase,
                    task: phase === 'composition' ? compositionTasks[taskIndex].map(x => x.label).join('; ') : transcriptionTasks[taskIndex],
                    time_s: duration,
                    response: text,
                    accuracy: accuracy
                };
                results.push(row);

                // G√• videre
                taskIndex++;
                if (phase === 'composition' && taskIndex >= compositionTasks.length) { phase = 'transcription'; taskIndex = 0; }
                else if (phase === 'transcription' && taskIndex >= transcriptionTasks.length) {
                    showQuestionnaire(); return;
                }

                renderTask();
            }

            // ------- Talegjenkjenning (Chrome/Edge) -------
            const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition || null;
            if (SpeechRec) {
                recognition = new SpeechRec();
                recognition.lang = 'no-NO'; // Norsk talegjenkjenning
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                recognition.continuous = false;

                voiceButton.addEventListener('click', () => {
                    try {
                        recognition.start();
                        status.textContent = 'üéôÔ∏è Lytter...';
                        voiceButton.setAttribute('aria-pressed', 'true');
                        startTime = startTime || performance.now();
                    } catch (err) {
                        status.textContent = '‚ö†Ô∏è Kan ikke starte mikrofon: ' + err.message;
                    }
                });

                recognition.onresult = (ev) => {
                    const text = ev.results[0][0].transcript;
                    inputField.value = text;
                    status.textContent = 'üü¢ Opptak fullf√∏rt.';
                    voiceButton.setAttribute('aria-pressed', 'false');
                };
                recognition.onerror = (ev) => {
                    status.textContent = '‚ö†Ô∏è Talegjenkjenning feil: ' + (ev.error || ev.message);
                    voiceButton.setAttribute('aria-pressed', 'false');
                };
                recognition.onend = () => { voiceButton.setAttribute('aria-pressed', 'false'); };
            } else {
                voiceButton.style.display = 'none';
                status.textContent = '‚ùå Stemmes√∏k ikke st√∏ttet i denne nettleseren.';
            }

            // ------- Sp√∏rreskjema flyt -------
            function showQuestionnaire() {
                document.querySelector('main').scrollIntoView({ behavior: 'smooth' });
                questionnaire.hidden = false;
                phaseTitle.textContent = 'Evaluering';
                promptText.textContent = '';
                inputField.style.display = 'none';
                document.querySelector('.controls').style.display = 'none';
            }

            finishButton.addEventListener('click', () => {
                const q1 = document.querySelector('input[name="q1"]:checked')?.value || '';
                const q2 = document.querySelector('input[name="q2"]:checked')?.value || '';
                const comments = el('comments').value || '';

                results.push({
                    participant: meta.participant,
                    interface: meta.interfaceType,
                    taskType: 'questionnaire',
                    task: `q1:${q1}; q2:${q2}`,
                    time_s: '',
                    response: comments,
                    accuracy: ''
                });

                downloadCSV(results, `eksperiment_resultater_${meta.participant}.csv`);
                localStorage.removeItem('participantID');
                localStorage.removeItem('interfaceType');

                document.body.innerHTML = '<div style="padding:30px;text-align:center"><h2>Takk for deltakelsen! ‚úÖ</h2><p>Resultatfilen ble lastet ned.</p></div>';
            });

            // ------- Verkt√∏yfunksjoner -------
            function computeAccuracy(target, actual) {
                const a = target.trim().toLowerCase();
                const b = (actual || '').trim().toLowerCase();
                if (a.length === 0) return 0;
                if (a === b) return 100;
                const dist = levenshtein(a, b);
                const maxL = Math.max(a.length, b.length);
                return (1 - dist / maxL) * 100;
            }

            function levenshtein(a, b) {
                const m = a.length,
                    n = b.length;
                const dp = Array.from({ length: m + 1 }, () => new Array(n + 1));
                for (let i = 0; i <= m; i++) dp[i][0] = i;
                for (let j = 0; j <= n; j++) dp[0][j] = j;
                for (let i = 1; i <= m; i++)
                    for (let j = 1; j <= n; j++) {
                        const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                        dp[i][j] = Math.min(dp[i - 1][j] + 1, dp[i][j - 1] + 1, dp[i - 1][j - 1] + cost);
                    }
                return dp[m][n];
            }

            function downloadCSV(objArray, filename) {
                if (!objArray || objArray.length === 0) return;
                const keys = ['participant', 'interface', 'taskType', 'task', 'time_s', 'response', 'accuracy'];
                const lines = [keys.join(',')];
                for (const row of objArray) {
                    const vals = keys.map(k => ('' + (row[k] || '')).replace(/"/g, '""'));
                    lines.push(vals.map(v => `"${v}"`).join(','));
                }
                const csv = lines.join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename || 'resultater.csv';
                document.body.appendChild(a);
                a.click();
                setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 1500);
            }

            // Vent til brukeren trykker "Start"
            document.getElementById('startButton').addEventListener('click', () => {
                document.getElementById('introScreen').hidden = true;
                document.getElementById('experimentSection').hidden = false;
                renderTask();
            });


            // Tilgjengelig for feils√∏king om √∏nskelig
            window._experiment = { results, renderTask, downloadCSV };
        })();
    </script>
</body>

</html>